version: "3.9"
networks:
  default:
    name: ${SERVER_NETWORK_NAME}

services:
  server:
    build: .
    container_name: ${SERVER_CONTAINER_NAME}
    ports:
      - target: ${SERVER_TARGET_PORT}
        published: ${SERVER_PUBLISHED_PORT}
    depends_on:
      - mariadb
      - redis
    entrypoint: [ "/app/wait-for-it.sh", "mariadb:3306", "-s", "--",
               "/app/wait-for-it.sh", "redis:6379", "-s", "--",
               "sh", "-c", "java ${JAVA_OPTS} -jar /app/app.jar" ]

  mariadb:
    image: "mariadb:10.5"
    container_name: ${MARIADB_CONTAINER_NAME}
    volumes:
      - type: bind
        source: ${MARIADB_INIT_MOUNTPOINT}
        target: /docker-entrypoint-initdb.d
    environment:
      # see also ./deploy/application.
      MARIADB_ROOT_PASSWORD: "root"
      MARIADB_DATABASE: "bitrxc"

  redis:
    image: "redis:6.2"
    container_name: ${REDIS_CONTAINER_NAME}
    volumes:
      - type: bind
        source: ${REDIS_CONF_MOUNTPOINT}
        target: /etc/redis
      - type: bind
        source: ${REDIS_DATA_MOUNTPOINT}
        target: /data
    entrypoint: [ "redis-server", "/etc/redis/redis.conf" ]